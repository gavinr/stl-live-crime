import{Q as t,G as e,bT as r,j7 as o,bO as n,aD as s,f9 as a}from"./vendor.982f672a.js";import{a as i}from"./quat.fa87ff61.js";import{b as c,a as u,d as l,r as f,o as m,e as p,t as d,g as b,q as x,i as g,j as v,v as w,k as h,m as y,p as j,w as C}from"./DefaultMaterial_COLOR_GAMMA.bb51f892.js";import{m as A,c as M,y as T,f as B}from"./meshFeatureSet.47781d2b.js";import{T as F,i as I,c as S,x as E,u as O,L as R,O as q,E as L}from"./BufferView.d0134247.js";import{a as D,f as G,h as N,r as k,c as Q,n as V}from"./vec33.35bce627.js";import{k as _}from"./georeference.2aaf16a1.js";import"./vec4.d45a60c6.js";import"./types.cbf711d3.js";import"./Version.2f13d119.js";import"./earcut.b5c0cad1.js";import"./deduplicate.7c9697bc.js";async function z(a,i,m){const p=new c(function(r){return null!=r&&r.resolveFile?{busy:!1,request:async(o,n,s)=>{const a=r.resolveFile(o),i="image"===n?"image":"binary"===n?"array-buffer":"json";return(await t(a,{responseType:i,signal:e(s)?s.signal:null})).data}}:null}(m)),d=(await u(p,i,m,!0)).model,b=d.lods.shift(),x=new Map,g=new Map;d.textures.forEach(((t,e)=>x.set(e,function(t){return new A({data:t.data,wrap:U(t.parameters.wrap)})}(t)))),d.materials.forEach(((t,e)=>g.set(e,function(t,e){const a=new n(function(t,e){return f(J(t[0]),J(t[1]),J(t[2]),e)}(t.color,t.opacity)),i=t.emissiveFactor?new n((c=t.emissiveFactor,s(J(c[0]),J(c[1]),J(c[2])))):null;var c;return new M({color:a,colorTexture:r(o(t.textureColor,(t=>e.get(t)))),normalTexture:r(o(t.textureNormal,(t=>e.get(t)))),emissiveColor:i,emissiveTexture:r(o(t.textureEmissive,(t=>e.get(t)))),occlusionTexture:r(o(t.textureOcclusion,(t=>e.get(t)))),alphaMode:P(t.alphaMode),alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,metallic:t.metallicFactor,roughness:t.roughnessFactor,metallicRoughnessTexture:r(o(t.textureMetallicRoughness,(t=>e.get(t))))})}(t,x))));const v=function(t){let e=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1};for(const{attributes:{position:o,normal:n,color:s,tangent:a,texCoord0:i}}of t.parts)e+=o.count,n&&(r.normal=!0),s&&(r.color=!0),a&&(r.tangent=!0),i&&(r.texCoord0=!0);return{writeIndex:0,vertexAttributes:{position:l(F,e),normal:r.normal?l(I,e):null,tangent:r.tangent?l(S,e):null,color:r.color?l(E,e):null,texCoord0:r.texCoord0?l(O,e):null},components:[]}}(b);for(const t of b.parts)K(v,t,g);const{position:w,normal:h,tangent:y,color:j,texCoord0:C}=v.vertexAttributes,B={position:w.typedBuffer,normal:e(h)?h.typedBuffer:null,tangent:e(y)?y.typedBuffer:null,uv:e(C)?C.typedBuffer:null,color:e(j)?j.typedBuffer:null},R=_(B,a,m);return{transform:R.transform,components:v.components,spatialReference:a.spatialReference,vertexAttributes:new T({position:R.vertexAttributes.position,normal:R.vertexAttributes.normal,tangent:R.vertexAttributes.tangent,color:B.color,uv:B.uv})}}function K(t,r,o){const{position:n,normal:s,tangent:c,color:u,texCoord0:l}=t.vertexAttributes,f=t.writeIndex,m=r.attributes.position.count;if(D(n.slice(f,m),r.attributes.position,r.transform),e(r.attributes.normal)&&e(s)){const t=a(i(),r.transform);G(s.slice(f,m),r.attributes.normal,t)}else e(s)&&N(s,0,0,1,{dstIndex:f,count:m});if(e(r.attributes.tangent)&&e(c)){const t=a(i(),r.transform);p(c.slice(f,m),r.attributes.tangent,t)}else e(c)&&d(c,0,0,1,1,{dstIndex:f,count:m});if(e(r.attributes.texCoord0)&&e(l)?b(l.slice(f,m),r.attributes.texCoord0):e(l)&&x(l,0,0,{dstIndex:f,count:m}),e(r.attributes.color)&&e(u)){const t=r.attributes.color,e=u.slice(f,m);if(4===t.elementCount)t instanceof S?g(e,t,255):t instanceof E?v(e,t):t instanceof R&&w(e,t,8);else{d(e,255,255,255,255);const r=q.fromTypedArray(e.typedBuffer,e.typedBufferStride);t instanceof I?k(r,t,255):t instanceof q?Q(r,t):t instanceof L&&V(r,t,8)}}else e(u)&&d(u.slice(f,m),255,255,255,255);const A=function(t,e){switch(e){case 4:return j(t,C);case 5:return y(t);case 6:return h(t)}}(r.indices||m,r.primitiveType);if(f)for(let e=0;e<A.length;e++)A[e]+=f;t.components.push(new B({faces:A,material:o.get(r.material).clone(),trustSourceNormals:!0})),t.writeIndex+=m}function P(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function U(t){return{horizontal:H(t.s),vertical:H(t.t)}}function H(t){switch(t){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function J(t){return t**(1/m)*255}export{z as loadGLTFMesh};
