import{w as e,S as t,i as n,s as r,e as s,a,b as o,c as i,d as c,n as l,f as u,g as d,o as m,h as p,j as f,W as g,k as h,l as v,m as w,p as y,q as $,t as b,r as C,u as x,v as M,x as S,y as k,z as L,A as T,B as z,C as D,D as j}from"./vendor.6e209a4d.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&(t.referrerPolicy=e.referrerpolicy),"use-credentials"===e.crossorigin?t.credentials="include":"anonymous"===e.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const q=e([]),A=e=>{let t=Math.abs((new Date).getTime()-new Date(e).getTime()),n=10;return t<36e5?n=30:t<72e5&&(n=20),n},P=(e,t)=>{console.log("querySelectorAllFunction query:",e,"context: ",t);const n=Array.prototype.slice.call(t.querySelectorAll(e));return console.log("res",n),n},I=async e=>{console.log("getCrime",e);const[t,n,r,s]=P("td",e).map((e=>e.querySelector("font").innerHTML)),a=r.replace("XX ","00 ").replace(" / "," and ")+", St. Louis, MO, USA",o=await(async e=>{var t=new URL("https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/find"),n={text:e,f:"json"};Object.keys(n).forEach((e=>t.searchParams.append(e,n[e])));const r=await fetch(t.toString());return await r.json()})(a);let i=!1,c=!1;o.locations.length>0&&o.locations[0].feature.attributes.Score>90&&(i=o.locations[0].feature.geometry.y,c=o.locations[0].feature.geometry.x);return{date:t,id:n,address:a,offense:s,size:A(t),lat:i,lon:c}},N=async()=>{console.log("getCrimes");const e=await fetch("https://jsonp.afeld.me?url=http://www.slmpd.org/cfs.aspx"),t=await e.text();var n=(new DOMParser).parseFromString(t,"text/html");const r=P("table tbody tr",n).map(I);return Promise.all(r)};function B(e){let t,n,r,d;return{c(){t=s("main"),n=s("div"),a(n,"class","svelte-cbm4uo"),a(t,"class","svelte-cbm4uo")},m(s,a){o(s,t,a),i(t,n),r||(d=c(e[0].call(null,n)),r=!0)},p:l,i:l,o:l,d(e){e&&u(t),r=!1,d()}}}function F(e,t,n){let{selectedCrime:r}=t,{centerMap:s=!1}=t;const a=d();let o,i,c;const l=q.subscribe((e=>{n(5,c=e)}));m(l);return e.$$set=e=>{"selectedCrime"in e&&n(1,r=e.selectedCrime),"centerMap"in e&&n(2,s=e.centerMap)},e.$$.update=()=>{if(30&e.$$.dirty&&o&&r)if(r){!0===s&&n(3,o.center=[r.lon,r.lat],o);const e=i.graphics.find((e=>e.attributes.id===r.id));n(3,o.popup.features=[e],o),n(3,o.popup.location=e.geometry,o),n(3,o.popup.visible=!0,o)}else n(3,o.popup.visible=!1,o);if(48&e.$$.dirty&&c&&c.length>0){let e=c.map((e=>{if(e.lat&&e.lon){const t=new p({latitude:e.lat,longitude:e.lon}),n={type:"simple-marker",style:"circle",color:"green",size:e.size+"px",outline:{color:[255,255,0],width:3}};return new f({geometry:t,symbol:n,attributes:e,popupTemplate:{title:e.offense,content:"{date}<br />{address}"}})}}));i.removeAll(),i.addMany(e)}},[e=>{n(3,o=new g({container:e,map:{basemap:"streets"},zoom:12,center:[-90.28,38.6]})),n(4,i=new h),o.map.add(i),o.watch("popup.visible",(e=>{!1===e&&a("selected",!1)})),o.on("click",(function(e){o.hitTest(e).then((function(e){if(e.results.length){var t=e.results.filter((function(e){return e.graphic.layer===i}))[0].graphic;a("selected",t.attributes)}else a("selected",!1)}))}))},r,s,o,i,c]}class O extends t{constructor(e){super(),n(this,e,F,B,r,{selectedCrime:1,centerMap:2})}}function U(e){let t,n,r;return{c(){t=s("span"),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm0-9a1 1 0 0 1 1 1v4a1 1 0 0 1-2 0v-4a1 1 0 0 1 1-1zm0-4a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"></path></svg>',a(t,"class","svelte-1ow4dq9")},m(s,a){o(s,t,a),n||(r=v(t,"click",e[0]),n=!0)},p:l,i:l,o:l,d(e){e&&u(t),n=!1,r()}}}function _(e,t,n){let{name:r=""}=t;return e.$$set=e=>{"name"in e&&n(1,r=e.name)},[()=>{w.fire({title:`About ${r}`,html:'This is a live view of the City of St. Louis Police Department <a href="http://www.slmpd.org/cfs.aspx" target="_blank">calls for service</a>. These are just requests - none of these crimes have been verified, charged, or prosecuted. Please leave feedback this project here: <a href="https://github.com/gavinr/stl-live-crime" target="_blank">github.com/gavinr/stl-live-crime</a>.',icon:"info",confirmButtonText:"Cool"})},r]}class E extends t{constructor(e){super(),n(this,e,_,U,r,{name:1})}}function H(e,t,n){const r=e.slice();return r[5]=t[n],r}function X(e){let t;return{c(){t=b("Loading ...")},m(e,n){o(e,t,n)},p:l,d(e){e&&u(t)}}}function G(e){let t,n=e[1],r=[];for(let s=0;s<n.length;s+=1)r[s]=K(H(e,n,s));return{c(){for(let e=0;e<r.length;e+=1)r[e].c();t=y()},m(e,n){for(let t=0;t<r.length;t+=1)r[t].m(e,n);o(e,t,n)},p(e,s){if(7&s){let a;for(n=e[1],a=0;a<n.length;a+=1){const o=H(e,n,a);r[a]?r[a].p(o,s):(r[a]=K(o),r[a].c(),r[a].m(t.parentNode,t))}for(;a<r.length;a+=1)r[a].d(1);r.length=n.length}},d(e){S(r,e),e&&u(t)}}}function K(e){let t,n,r,c,l,d,m,p,f,g,h,w,y=e[5].offense+"",$=new Intl.DateTimeFormat("en-US",{hour:"numeric",minute:"numeric",second:"numeric"}).format(new Date(e[5].date))+"",S=e[5].address+"";function k(){return e[3](e[5])}return{c(){t=s("div"),n=b(y),r=C(),c=s("br"),l=C(),d=b($),m=s("br"),p=C(),f=b(S),g=C(),a(t,"class","card svelte-5g9mpc"),x(t,"highlight",e[0]&&e[5].id===e[0].id)},m(e,s){o(e,t,s),i(t,n),i(t,r),i(t,c),i(t,l),i(t,d),i(t,m),i(t,p),i(t,f),i(t,g),h||(w=v(t,"click",k),h=!0)},p(r,s){e=r,2&s&&y!==(y=e[5].offense+"")&&M(n,y),2&s&&$!==($=new Intl.DateTimeFormat("en-US",{hour:"numeric",minute:"numeric",second:"numeric"}).format(new Date(e[5].date))+"")&&M(d,$),2&s&&S!==(S=e[5].address+"")&&M(f,S),3&s&&x(t,"highlight",e[0]&&e[5].id===e[0].id)},d(e){e&&u(t),h=!1,w()}}}function R(e){let t;function n(e,t){return e[1].length>0?G:X}let r=n(e),s=r(e);return{c(){s.c(),t=y()},m(e,n){s.m(e,n),o(e,t,n)},p(e,[a]){r===(r=n(e))&&s?s.p(e,a):(s.d(1),s=r(e),s&&(s.c(),s.m(t.parentNode,t)))},i:l,o:l,d(e){s.d(e),e&&u(t)}}}function W(e,t,n){let r;$(e,q,(e=>n(1,r=e)));let{selectedCrime:s}=t;const a=d();function o(e){a("click",e)}return e.$$set=e=>{"selectedCrime"in e&&n(0,s=e.selectedCrime)},[s,r,o,e=>o(e)]}class J extends t{constructor(e){super(),n(this,e,W,R,r,{selectedCrime:0})}}function Q(e){let t,n,r,c,l,d,m,p,f,g,h;return l=new E({props:{name:e[2]}}),m=new O({props:{selectedCrime:e[0],centerMap:e[1]}}),m.$on("selected",e[4]),g=new J({props:{selectedCrime:e[0]}}),g.$on("click",e[5]),{c(){t=s("header"),n=b(e[2]),r=C(),c=s("span"),k(l.$$.fragment),d=C(),k(m.$$.fragment),p=C(),f=s("aside"),k(g.$$.fragment),a(c,"class","svelte-4xg6uf"),a(t,"class","svelte-4xg6uf"),a(f,"id","sidebar"),a(f,"class","svelte-4xg6uf")},m(e,s){o(e,t,s),i(t,n),i(t,r),i(t,c),L(l,c,null),o(e,d,s),L(m,e,s),o(e,p,s),o(e,f,s),L(g,f,null),h=!0},p(e,[t]){(!h||4&t)&&M(n,e[2]);const r={};4&t&&(r.name=e[2]),l.$set(r);const s={};1&t&&(s.selectedCrime=e[0]),2&t&&(s.centerMap=e[1]),m.$set(s);const a={};1&t&&(a.selectedCrime=e[0]),g.$set(a)},i(e){h||(T(l.$$.fragment,e),T(m.$$.fragment,e),T(g.$$.fragment,e),h=!0)},o(e){z(l.$$.fragment,e),z(m.$$.fragment,e),z(g.$$.fragment,e),h=!1},d(e){e&&u(t),D(l),e&&u(d),D(m,e),e&&u(p),e&&u(f),D(g)}}}function V(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,a){function o(e){try{c(r.next(e))}catch(t){a(t)}}function i(e){try{c(r.throw(e))}catch(t){a(t)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,i)}c((r=r.apply(e,t||[])).next())}))};let{name:s}=t,{selectedCrime:a}=t,{centerMap:o=!1}=t;function i(e,t){a==e.detail||!1===e.detail?n(0,a=void 0):(n(1,o=t),n(0,a=e.detail))}j((function(){return r(this,void 0,void 0,(function*(){(async()=>{const e=await N();q.update((t=>e)),setInterval((async()=>{const e=await N();console.log("updating",e),q.update((t=>e))}),6e4)})()}))}));return e.$$set=e=>{"name"in e&&n(2,s=e.name),"selectedCrime"in e&&n(0,a=e.selectedCrime),"centerMap"in e&&n(1,o=e.centerMap)},[a,o,s,i,e=>{i(e,!1)},e=>{i(e,!0)}]}new class extends t{constructor(e){super(),n(this,e,V,Q,r,{name:2,selectedCrime:0,centerMap:1})}}({target:document.getElementById("app"),props:{name:"St. Louis Live Crime"}});
